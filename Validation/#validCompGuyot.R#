load("IPDRecGuyot.RData")
load("IPD.RData")

sims = 50
params <- c("time", "n.risk", "n.event", "n.censor", "surv")
versions <- c("original", "reconstructed")
sizes <- c("small", "medium", "large")
arms <- c(1,2)
intervals <- c("20%", "40%", "60%", "80%", "100%")

comp <- array(data = NA,
              dim = c(50, 3, 2, 2, length(intervals), length(params)),
              dimnames = list(1:sims,
                              sizes,
                              version,
                              arms,
                              intervals,
                              params))

library(survival)

for(w in 1:length(IPD)){
  for(s in 1:sims){
    fit <- survfit(Surv(time, status) ~ stratum, data=IPD[[w]][[s]])
    fitR <- survfit(Surv(time, status) ~ stratum, data=IPDRec[[w]][[s]])

    s1 <- array(data = NA,
                dim = c(fit$strata[1],
                        length(params)),
                dimnames = list(1:fit$strata[1],
                                params))

    s2 <- array(data = NA,
                dim = c(fit$strata[2],
                        length(params)),
                dimnames = list(1:fit$strata[2],
                                params))

    for(i in 1:length(params)){
      s1[,i] <- head(fit[[params[i]]], fit$strata[1])
      s2[,i] <- tail(fit[[params[i]]], fit$strata[2])
    }

    sR1 <- array(data = NA,
                 dim = c(fitR$strata[1],
                         length(params)),
                 dimnames = list(1:fitR$strata[1],
                                 params))

    sR2 <- array(data = NA,
                 dim = c(fitR$strata[2],
                         length(params)),
                 dimnames = list(1:fitR$strata[2],
                                 params))

    for(i in 1:length(params)){
      sR1[,i] <- head(fitR[[params[i]]], fitR$strata[1])
      sR2[,i] <- tail(fitR[[params[i]]], fitR$strata[2])
    }

    j <- 1
    arm <- 1
    version <- 1
    for(S in list(s1, s2, sR1, sR2)){
      T <- max(c(s1[,"time"], s2[,"time"], sR1[,"time"], sR2[,"time"]))
      fractions <- c(T/5, 2 * T/5, 3 * T/5, 4* T/5, T)
      index <-  c()
      for(f in fractions) index <- c(index, max(which(S[,"time"] <= f)))
      prev <- c(1, index[1:(length(index)-1)])
      comp[s, w, version, arm, , c("time", "n.risk", "surv")] <-
        S[index,c("time", "n.risk", "surv")]
      for(i in 1:5){
        if(prev[i] == index[i])
          comp[s ,w ,version ,arm ,i ,c("n.censor", "n.event")] <-
            S[prev[i]:index[i],c("n.censor", "n.event")]
        else
          comp[s,w,version,arm,i,c("n.censor", "n.event")] <-
            colSums(S[prev[i]:index[i],c("n.censor", "n.event")])
      }
      if(j == 1) {arm <- 2; j = j + 1
      } else {
        if(j == 2) {arm <- 1; version <- 2; j = j + 1
        } else {
          if(j == 3) arm <- 2; version <- 2; j = j + 1
        }
      }
    }    
  }
}


arm1 <- comp[,,"reconstructed",1,,] - comp[,,"original",1,,]
arm2 <- comp[,,"reconstructed",2,,] - comp[,,"original",2,,]

diffs <- abind(arm1, arm2, along = 1)

save(diffs, file = "diffsGuyot.RData")
