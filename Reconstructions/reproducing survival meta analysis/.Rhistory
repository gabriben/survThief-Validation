stanWeibFitFunc <-
stanWeibFitDraws %>%
select(.chain, .iteration, .draw, alpha, mu, `beta_bg[1]`) %>%
## Simplify name
rename(beta = `beta_bg[1]`) %>%
## Construct realization of random functions
mutate(`S(t|1)` = pmap(list(alpha, mu, beta), function(a,m,b) {construct_survival_function(a,m,b,1)}),
`S(t|0)` = pmap(list(alpha, mu, beta), function(a,m,b) {construct_survival_function(a,m,b,0)}))
stanWeibFitDraws <- tidybayes::tidy_draws(stanWeibFit)
## Random functions
stanWeibFitFunc <-
stanWeibFitDraws %>%
select(.chain, .iteration, .draw, alpha, mu, `beta_bg[1]`) %>%
## Simplify name
rename(beta = `beta_bg[1]`) %>%
## Construct realization of random functions
mutate(`S(t|1)` = pmap(list(alpha, mu, beta), function(a,m,b) {construct_survival_function(a,m,b,1)}),
`S(t|0)` = pmap(list(alpha, mu, beta), function(a,m,b) {construct_survival_function(a,m,b,0)}))
times <- seq(from = 0, to = 160, by = 0.1)
times_df <- data_frame(t = times)
## save(d, file = "meta.RData")
load("meta.RData")
max(d$time)
up10(max(d$time))
up10 <- function(x) 10^ceiling(log10(x))
up10(max(d$time))
max(d$time)
up10 <- function(x) ceiling(x/10)*10
up10(max(d$time)
)
times <- seq(from = 0, to = up10(max(d$time)), by = 0.1)
times_df <- data_frame(t = times)
## Try first realizations
stanWeibFitFunc$`S(t|1)`[[1]](times[1:10])
stanWeibFitFunc$`S(t|0)`[[1]](times[1:10])
library(tidyr)
stanWeibFitSurv <-
stanWeibFitFunc %>%
mutate(times_df = list(times_df)) %>%
mutate(times_df = pmap(list(times_df, `S(t|1)`, `S(t|0)`),
function(df, s1, s0) {df %>% mutate(s1 = s1(t),
s0 = s0(t))})) %>%
select(-`S(t|1)`, -`S(t|0)`) %>%
unnest() %>%
gather(key = treatment, value = survival, s1, s0) %>%
mutate(treatment = factor(treatment,
levels = c("s1","s0"),
labels = c("open","hybrid")))
stanWeibFitSurv$survival
quantile(stanWeibFitSurv$survival, probs = 0.975)
quantile(stanWeibFitSurv$survival, probs = c(0.975, 0.025))
quantile(stanWeibFitSurv$survival, probs = seq(0.025, 0.975, 0.025))
list(quantile(stanWeibFitSurv$survival, probs = seq(0.025, 0.975, 0.025)))
q <- quantile(stanWeibFitSurv$survival, probs = seq(0.025, 0.975, 0.025))
length(q)
LETTERS
probs = seq(0.025, 0.975, 0.025)
probs = seq(0.025, 0.975, 0.025)
for(i in probs) {
nam <- paste("q", i, sep = "")
assign(nam, quantile(survival, probs = i))
}
for(i in probs) {
nam <- paste("q", i, sep = "")
assign(nam, quantile(stanWeibFitSurv$survival, probs = i))
}
q0.025
q0.05
quantiles <- ""
paste("ssa", "sadsa")
probs = seq(0.025, 0.975, 0.025)
quantiles <- ""
for(i in probs) {
nam <- paste("q", i, sep = "")
assign(nam, quantile(stanWeibFitSurv$survival, probs = i))
quantiles <- paste(quantiles, "/n" ,nam, "<- quantile(stanWeibFitSurv$survival, probs = ", i, "),")
}
quantiles
cat(quantiles)
quantiles <- ""
for(i in probs) {
nam <- paste("q", i, sep = "")
assign(nam, quantile(stanWeibFitSurv$survival, probs = i))
quantiles <- paste(quantiles, nam, "<- quantile(survival, probs = ", i, "),")
}
quantiles
nchar(quantiles)
quantiles <- substr(quantile, 1, nchar(quantiles))
nchar(quantiles)
nchar(quantiles)
quantiles <- substr(quantile, 1, nchar(quantiles))
substr(quantile, 1, nchar(quantiles))
substr(quantile, 1, 10)
quantile
quantiles <- ""
for(i in probs) {
nam <- paste("q", i, sep = "")
# assign(nam, quantile(stanWeibFitSurv$survival, probs = i))
quantiles <- paste(quantiles, nam, "<- quantile(survival, probs = ", i, "),")
}
quantiles <- substr(quantiles, 1, nchar(quantiles))
quantiles
quantiles <- substr(quantiles, 1, nchar(quantiles))
quantiles
quantiles <- substr(quantiles, 1, nchar(quantiles) - 1)
quantiles
## Average on survival scale
stanWeibFitSurvMean <-
stanWeibFitSurv %>%
group_by(treatment, t) %>%
summarize(survival_mean = mean(survival), eval(parse(text=quantiles)))
testCode <- paste("stanWeibFitSurvMean <-
stanWeibFitSurv %>%
group_by(treatment, t) %>%
summarize(survival_mean = mean(survival),", quantiles, ")")
textCode <- paste("stanWeibFitSurvMean <-
stanWeibFitSurv %>%
group_by(treatment, t) %>%
summarize(survival_mean = mean(survival),", quantiles, ")")
textCode
textCode <- paste("stanWeibFitSurvMean <- stanWeibFitSurv %>% group_by(treatment, t) %>% summarize(survival_mean = mean(survival),", quantiles, ")")
textCode
eval(parse(text=textCode))
str(stanWeibFitSurvMean)
save(stanWeibFitSurvMean, file = "weibFitGranular.rds")
length(probs)
probs == 0.5
probs <- probs(!probs == 0.5)
probs
probs == 0.5
probs <- probs[!probs == 0.5]
probs
names(stanWeibFitSurvMean)
0.025 %in% names(stanWeibFitSurvMean)
names(stanWeibFitSurvMean) %in% 0.025
for(i in 1: length(probs/2)){
combPlot <-  combPlot + geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t, ymax=x.upper, ymin=x.lower), fill="pink", alpha=.5)
}
names(stanWeibFitSurvMean) %in% 0.025
names(stanWeibFitSurvMean) %in% "0.025"
grep("0.025", stanWeibFitSurvMean)
grepexp("0.025", stanWeibFitSurvMean)
grepexpr("0.025", stanWeibFitSurvMean)
grepl("0.025", stanWeibFitSurvMean)
grepl("0.025", stanWeibFitSurvMean, fixed = T)
grepl("q0.025", stanWeibFitSurvMean)
grepl("q0.025", stanWeibFitSurvMean)
grepl("q0.025", names(stanWeibFitSurvMean))
grepl("0.025", names(stanWeibFitSurvMean))
grepl(as.charachter(probs[i]), names(stanWeibFitSurvMean))
grepl(as.character(probs[i]), names(stanWeibFitSurvMean))
rev(probs)[i]
colfunc <- colorRampPalette(c("red", "pink"))
colfunc(10)
cols <- colfunc(length(probs)/2)
## pdf("weibFit.pdf",width=14,height=10)
library(tidyverse)
library(ggplot2)
colnames(d)[1] <- "time"
library(survival)
fit <- survfit(Surv(time, status) ~ stratum, data=d)
library(survminer)
## pdf("results/detectCensoring V2.pdf",width=14,height=10)
KMPlot <- ggsurvplot(fit, risk.table = T, tables.theme = theme_cleantable(),
risk.table.col = "strata", RUEpval = TRUE,
ggtheme = theme_bw(), risk.table.y.text=F,
break.time.by=12)
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
combPlot
colfunc <- colorRampPalette(c("red", "pink"))
cols <- colfunc(length(probs)/2)
for(i in 1: length(probs)/2){
combPlot <-  combPlot + geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean)),
ymin=grepl(as.character(probs[i]), names(stanWeibFitSurvMean))),
fill=cols[i], alpha=.5)
}
combPlot
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
combPlot
for(i in 1: length(probs)/2){
combPlot <-  combPlot + geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean)),
ymin=grepl(as.character(probs[i]), names(stanWeibFitSurvMean))),
fill=cols[i], alpha=.5)
}
combPlot
traceback()
for(i in 1: length(probs)/2){
combPlot <-  combPlot$plot + geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean)),
ymin=grepl(as.character(probs[i]), names(stanWeibFitSurvMean))),
fill=cols[i], alpha=.5)
}
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
colfunc <- colorRampPalette(c("red", "pink"))
cols <- colfunc(length(probs)/2)
for(i in 1: length(probs)/2){
combPlot <-  combPlot$plot + geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean)),
ymin=grepl(as.character(probs[i]), names(stanWeibFitSurvMean))),
fill=cols[i], alpha=.5)
}
combPlot
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))+
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean)),
ymin=grepl(as.character(probs[i]), names(stanWeibFitSurvMean))),
fill=cols[i], alpha=.5)
combPlot
## pdf("results/detectCensoring V2.pdf",width=14,height=10)
KMPlot <- ggsurvplot(fit, risk.table = T, tables.theme = theme_cleantable(),
risk.table.col = "strata", RUEpval = TRUE,
ggtheme = theme_bw(), risk.table.y.text=F,
break.time.by=12)
KMPlot
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))+
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean)),
ymin=grepl(as.character(probs[i]), names(stanWeibFitSurvMean))),
fill=cols[i], alpha=.5)
combPlot
grepl(as.character(rev(probs)[i]), names(stanWeibFitSurvMean))
stanWeibFitSurvMean %>% .[grepl(as.character(rev(probs)[i]), names(.))]
ymin=grepl(stanWeibFitSurvMean %>%
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))+
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]),
ymin=grepl(stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]),
fill=cols[i], alpha=.5)
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))+
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=grepl(stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]),
ymin=grepl(stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]),
fill=cols[i], alpha=.5))
combPlot
grepl(stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))])
grepl(stanWeibFitSurvMean %>% .[grepl(as.character(rev(probs)[i]), names(.))])
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))])
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))+
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
fill=cols[i], alpha=.5))
combPlot
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]
cols[i]
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
combPlot
traceback()
bayesPlot <- ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
fill=cols[i], alpha=.5))
bayesPlot
traceback()
ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean))
ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
fill=cols[i], alpha=.5))
bayesPlot <- ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))],
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))],
fill=cols[i], alpha=.5))
bayesPlot
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]
stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))]
ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=rep(40,t),
ymin=rep(20,t),
fill=cols[i], alpha=.5))
times
ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=rep(40,length(times)),
ymin=rep(20,length(times)),
fill=cols[i], alpha=.5))
ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=rep(40,3202),
ymin=rep(20,3202),
fill=cols[i], alpha=.5))
cols[i]
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))]
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE)
KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))+
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5))
ggplot(data = stanWeibFitSurvMean,
mapping = aes(x = t, group = treatment, color = fct_rev(treatment))) +
geom_line(aes(y = survival_mean)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5))
KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
i <- 10
KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
(probs)[i])
KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment)) +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t, group = treatment,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
for(i in 1: length(probs)/2){
combPlot <-  combPlot +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t, group = treatment,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
}
combPlot
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
for(i in 1: length(probs)/2){
combPlot <-  combPlot$plot +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t, group = treatment,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
}
combPlot
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
combPlot
1: length(probs)/2
length(probs)
length(probs)/2
for(i in 1: length(probs)/2){
combPlot <-  combPlot +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t, group = treatment,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=.5), inherit.aes = FALSE)
}
combPlot
length(probs)/2
rev(probs)[i]
i
probs[i]
grepl(as.character(probs[i]), names(.))
stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE)
cols
combPlot <- KMPlot$plot +
geom_line(data = stanWeibFitSurvMean,
mapping = aes(x = t,y = survival_mean, group = treatment, color = treatment))
for(i in 1: length(probs)/2){
combPlot <-  combPlot +
geom_ribbon(data = stanWeibFitSurvMean,
mapping = aes(x=t, group = treatment,
ymax=stanWeibFitSurvMean %>%
.[grepl(as.character(rev(probs)[i]), names(.))] %>%
unlist(use.names = FALSE),
ymin=stanWeibFitSurvMean %>%
.[grepl(as.character(probs[i]), names(.))] %>%
unlist(use.names = FALSE),
fill=cols[i], alpha=1), inherit.aes = FALSE)
}
combPlot
stanWeibFitSurvMean$`q0.025 <- quantile(survival, probs = 0.025)`
